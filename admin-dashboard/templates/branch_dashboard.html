<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ branch.name }} Dashboard - Axiom Emergencies</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .collapsible-section {
            margin-bottom: 20px;
        }
        .collapsible-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #dee2e6;
            transition: all 0.3s ease;
        }
        .collapsible-header:hover {
            background: #e9ecef;
        }
        .collapsible-header h3 {
            margin: 0;
            font-size: 1.1em;
        }
        .collapsible-toggle {
            font-size: 1.5em;
            transition: transform 0.3s ease;
        }
        .collapsible-toggle.open {
            transform: rotate(180deg);
        }
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .collapsible-content.open {
            max-height: 2000px;
            transition: max-height 0.5s ease;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <h1>üö® Axiom Emergencies - {{ branch.name }}</h1>
        </div>
        <div class="nav-menu">
            <a href="{{ url_for('dashboard') }}" class="nav-link">‚Üê Back to Main Dashboard</a>
            <span class="nav-user">üë§ {{ session.username }}</span>
            <a href="{{ url_for('logout') }}" class="nav-link">Logout</a>
        </div>
    </nav>

    <div class="container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="dashboard-header">
            <h2>{{ branch.name }} Branch Dashboard</h2>
            <span class="status-badge status-{{ 'online' if status.online else 'offline' }}">
                {{ status.status }}
            </span>
        </div>

        {% if not status.enabled %}
        <div class="alert alert-warning">
            ‚ö†Ô∏è This branch is currently DISABLED. Emergency calls will not be processed.
        </div>
        {% endif %}

        <div class="branch-detail-card">
            <h3>Branch Information</h3>
            <div class="info-grid">
                <div class="info-item">
                    <label>Location:</label>
                    <span>{{ branch.name }}</span>
                </div>
                <div class="info-item">
                    <label>Status:</label>
                    <span class="status-text-{{ 'online' if status.online else 'offline' }}">
                        {{ status.status }}
                    </span>
                </div>
                <div class="info-item">
                    <label>Message:</label>
                    <span>{{ status.message }}</span>
                </div>
            </div>
        </div>

        {% if is_admin or (branch_key in user_permissions and user_permissions[branch_key].can_trigger) %}
        <div class="collapsible-section">
            <div class="collapsible-header" onclick="toggleCollapsible('trigger-emergency')">
                <h3>üö® Trigger Emergency</h3>
                <span class="collapsible-toggle" id="trigger-emergency-toggle">‚ñº</span>
            </div>
            <div class="collapsible-content" id="trigger-emergency-content">
                <div class="branch-detail-card" style="margin-top: 0;">
                    <p style="margin-bottom: 15px; color: #856404; background-color: #fff3cd; padding: 10px; border-radius: 4px;">
                        ‚ö†Ô∏è This will trigger a test emergency and notify the technician via SMS and call.
                    </p>
                    <form id="emergencyForm" onsubmit="triggerEmergency(event, '{{ branch_key }}', '{{ branch.name }}'); return false;">
                        <div class="form-group">
                            <label for="techPhone">Technician Phone:</label>
                            <input type="tel" id="techPhone" name="techPhone" placeholder="+12084039927" required style="width: 100%; padding: 8px; margin-bottom: 10px;">
                        </div>
                        <div class="form-group">
                            <label for="customerName">Customer Name:</label>
                            <input type="text" id="customerName" name="customerName" placeholder="Jane Doe" required style="width: 100%; padding: 8px; margin-bottom: 10px;">
                        </div>
                        <div class="form-group">
                            <label for="callbackNumber">Callback Number:</label>
                            <input type="tel" id="callbackNumber" name="callbackNumber" placeholder="+15551234567" required style="width: 100%; padding: 8px; margin-bottom: 10px;">
                        </div>
                        <div class="form-group">
                            <label for="address">Incident Address:</label>
                            <input type="text" id="address" name="address" placeholder="123 Main St, Town, State" required style="width: 100%; padding: 8px; margin-bottom: 10px;">
                        </div>
                        <div class="form-group">
                            <label for="description">Emergency Description:</label>
                            <textarea id="description" name="description" rows="3" placeholder="No heat, urgent repair needed" required style="width: 100%; padding: 8px; margin-bottom: 10px;"></textarea>
                        </div>
                        <button type="submit" class="btn btn-danger" style="width: 100%;">
                            üö® Trigger Emergency
                        </button>
                    </form>
                </div>
            </div>
        </div>
        {% endif %}

        {% if is_admin or (branch_key in user_permissions and (user_permissions[branch_key].can_edit_basic_settings or user_permissions[branch_key].can_edit_advanced_settings or user_permissions[branch_key].can_restart)) %}
        <div class="collapsible-section">
            <div class="collapsible-header" onclick="toggleCollapsible('advanced-info')">
                <h3>üîß Advanced Information</h3>
                <span class="collapsible-toggle" id="advanced-info-toggle">‚ñº</span>
            </div>
            <div class="collapsible-content" id="advanced-info-content">
                <div class="branch-detail-card" style="margin-top: 0;">
                    <div class="info-grid">
                        <div class="info-item">
                            <label>Public URL:</label>
                            <span><a href="{{ branch.public_url }}/status" target="_blank">{{ branch.public_url }}/status</a></span>
                        </div>
                        <div class="info-item">
                            <label>Internal URL:</label>
                            <span>{{ branch.url }}</span>
                        </div>
                        <div class="info-item">
                            <label>Enabled:</label>
                            <span>{{ 'Yes' if status.enabled else 'No' }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="iframe-container">
            <h3>Branch Dashboard</h3>
            <iframe src="{{ branch.public_url }}/status" frameborder="0" width="100%" height="600px"></iframe>
        </div>

        <div class="actions-section">
            <button class="btn btn-secondary" onclick="window.location.reload()">
                üîÑ Refresh
            </button>
            
            <a href="{{ url_for('branch_settings', branch=branch_key) }}" class="btn btn-primary">
                ‚öôÔ∏è Settings
            </a>
            
            {% if is_admin or (branch_key in user_permissions and user_permissions[branch_key].can_restart) %}
            <button class="btn btn-warning" onclick="restartBranch('{{ branch_key }}', '{{ branch.name }}')">
                üîÑ Restart Container
            </button>
            {% endif %}
            
            {% if is_admin %}
                {% if status.enabled %}
                <button class="btn btn-danger" onclick="disableBranch('{{ branch_key }}', '{{ branch.name }}')">
                    Disable Branch
                </button>
                {% else %}
                <button class="btn btn-success" onclick="enableBranch('{{ branch_key }}', '{{ branch.name }}')">
                    Enable Branch
                </button>
                {% endif %}
            {% endif %}
        </div>
    </div>

    <script>
        function toggleCollapsible(sectionId) {
            const content = document.getElementById(sectionId + '-content');
            const toggle = document.getElementById(sectionId + '-toggle');
            
            if (content.classList.contains('open')) {
                content.classList.remove('open');
                toggle.classList.remove('open');
            } else {
                content.classList.add('open');
                toggle.classList.add('open');
            }
        }
    </script>
    <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
</body>
</html>
